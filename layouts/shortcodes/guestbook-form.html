<form id="guestbook-form" method="POST" action="{{ .Site.Params.guestbookServer.url }}">
  <input name="redirect" type="hidden" value="{{ absURL "/guestbook-success" }}?success=true">
  
  <!-- Honeypot field (hidden from users, bots will fill it) -->
  <input name="website" type="text" style="display:none" tabindex="-1" autocomplete="off">
  
  <label>Name or Callsign <input name="name" type="text" alt="Name or Callsign" placeholder="Joe Bob" required></label><br/>
  <label>Optional Message <br/><textarea name="message" alt="Message" style="width: 90%; min-width: 100px;" placeholder="Hello!"></textarea></label><br/>
  
  <!-- reCAPTCHA v3 -->
  <div class="g-recaptcha" data-sitekey="{{ .Site.Params.reCaptcha.siteKey }}" data-callback="onRecaptchaSuccess"></div>
  
  <input type="submit" value="Submit" id="submit-button" disabled>
</form>
<small><i>
  All messages submitted are moderated, and any extra HTML/Markdown will be stripped -- only plaintext messages will be approved.
</i></small><br />

<!-- reCAPTCHA v3 Script -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
function onRecaptchaSuccess(token) {
    // Enable submit button when reCAPTCHA is completed
    document.getElementById('submit-button').disabled = false;
    
    // Add the token to the form
    const form = document.getElementById('guestbook-form');
    let tokenInput = form.querySelector('input[name="g-recaptcha-response"]');
    if (!tokenInput) {
        tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'g-recaptcha-response';
        form.appendChild(tokenInput);
    }
    tokenInput.value = token;
}

// Handle form submission
document.getElementById('guestbook-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = document.getElementById('submit-button');
    
    // Disable submit button to prevent double submission
    submitButton.disabled = true;
    submitButton.value = 'Submitting...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.message) {
            alert(data.message);
            // Reset form
            this.reset();
            document.getElementById('submit-button').disabled = true;
            submitButton.value = 'Submit';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('There was an error submitting your message. Please try again.');
        submitButton.disabled = false;
        submitButton.value = 'Submit';
    });
});
</script>
